#' Update GBIF endpoint
#'
#' Update FinBIF dataset endpoint for GBIF.
#'
#' @param endpoint Character. URL of dataset endpoint generated by
#'   `get_endpoint`.
#' @param uuid Character. GBIF dataset identifier.
#' @param url Character. URL of GBIF API. Defaults to system environment
#'   variable, "GBIF_API".
#' @param user Character. GBIF username. Defaults to system environment
#'   variable, "GBIF_USER".
#' @param pass Character. GBIF password. Defaults to system environment
#'   variable, "GBIF_PASS".
#'
#' @return If successful returns `NULL` invisibly.
#' @examples \dontrun{
#'
#' m <- get_metadata("HR.3991")
#' ep <- get_endpoint("HR.3991")
#' uuid <- send_gbif_dataset_metadata(m)
#' update_gbif_dataset_endpoint(ep, uuid)
#'
#' }
#' @importFrom httr authenticate content RETRY status_code
#' @importFrom jsonlite fromJSON
#' @export

update_gbif_dataset_endpoint <- function(
  endpoint,
  uuid,
  url = Sys.getenv("GBIF_API"),
  user = Sys.getenv("GBIF_USER"),
  pass = Sys.getenv("GBIF_PASS")
) {

  auth <- httr::authenticate(user, pass)

  res <- httr::RETRY(
    "GET",
    url = url,
    config = auth,
    path = sprintf("v1/dataset/%s/endpoint", uuid)
  )

  status <- httr::status_code(res)

  ok <- identical(status, 200L)

  stopifnot("Request failed. Could not get endpoints from GBIF" = ok)

  endpoint_old <- httr::content(res, "text", encoding = "UTF-8")

  endpoint_old <- jsonlite::fromJSON(endpoint_old, simplifyVector = TRUE)

  endpoint_urls <- vapply(endpoint, getElement, character(1L), "url")

  correct_ep <- endpoint_old[["url"]] %in% endpoint_urls

  wrong_ep <- endpoint_old[!correct_ep, ]

  for (i in seq_len(nrow(wrong_ep))) {

    key <- wrong_ep[[i, "key"]]

    res <- httr::RETRY(
      "DELETE",
      url = url,
      config = auth,
      path = sprintf("v1/dataset/%s/endpoint/%s", uuid, key)
    )

    status <- httr::status_code(res)

    ok <- identical(status, 204L)

    stopifnot("Request failed. Could not delete endpoint from GBIF" = ok)

    message(
      sprintf(
        "INFO [%s] Deleted endpoint %s from GBIF dataset %s",
        format(Sys.time()),
        wrong_ep[[i, "url"]],
        uuid
      )
    )

  }

  missing_ep <- !endpoint_urls %in% endpoint_old[["url"]]

  send_gbif_dataset_endpoint(endpoint[missing_ep], uuid, url, user, pass)

  invisible(NULL)

}
